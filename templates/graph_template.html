<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SEO –ì—Ä–∞—Ñ (Interactive Pro)</title>
    <script src="assets/echarts.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            background-color: #2C2C2E;
            font-family: 'Segoe UI', sans-serif;
        }

        #chart-container { width: 100%; height: 100%; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(40, 40, 45, 0.95);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            color: #fff;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 220px;
        }

        .controls h3 { margin: 0 0 5px 0; font-size: 12px; color: #6A9EFF; text-transform: uppercase; letter-spacing: 1px; }

        .btn-group { display: flex; flex-direction: column; gap: 6px; }

        button.layout-btn {
            background: #3A3A3C;
            color: #ccc;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            transition: all 0.3s ease;
        }

        button.layout-btn:hover { background: #4A4A4C; border-color: #888; color: #fff; }
        button.layout-btn.active { background: #3B82F6; color: #fff; border-color: #3B82F6; font-weight: 600; }

        .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 13px; cursor: pointer; user-select: none; }
        .checkbox-row input { cursor: pointer; accent-color: #3B82F6; }

        .stats-bar {
            margin-top: 5px;
            padding-top: 10px;
            border-top: 1px solid #444;
            font-size: 11px;
            color: #888;
            display: flex;
            justify-content: space-between;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Ç—É–ª—Ç–∏–ø–∞ */
        .tooltip-btn {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            border: 1px solid transparent;
        }
        .tooltip-btn:hover {
            border-color: rgba(255,255,255,0.3);
            filter: brightness(1.2);
        }
    </style>
</head>
<body>

<div class="controls">
    <h3>–í–∏–¥ –ì—Ä–∞—Ñ–∞</h3>
    <div class="btn-group">
        <button onclick="setForceLayout()" id="btn-force" class="layout-btn active">üï∏ –ü–∞—É—Ç–∏–Ω–∞ (–†–∞–∑—Ä—è–∂–µ–Ω–Ω–∞—è)</button>
        <button onclick="setCircularLayout()" id="btn-circular" class="layout-btn">‚≠ï –ö–æ–ª—å—Ü–æ (Circular)</button>
    </div>

    <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
    <label class="checkbox-row">
        <input type="checkbox" id="showTablets" checked onchange="updateData()">
        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¢–∞–±–ª–µ—Ç–∫–∏
    </label>

    <div class="stats-bar">
        <span>–£–∑–ª–æ–≤: <b id="stat-nodes" style="color:#eee">0</b></span>
        <span>–°–≤—è–∑–µ–π: <b id="stat-edges" style="color:#eee">0</b></span>
    </div>
</div>

<div id="chart-container"></div>

<script>
    // --- –î–ê–ù–ù–´–ï ---
    const rawNodes = (typeof NODES_DATA !== 'undefined') ? NODES_DATA : [];
    const rawEdges = (typeof EDGES_DATA !== 'undefined') ? EDGES_DATA : [];

    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
    let highlightState = {
        active: false,
        nodeId: null,
        direction: null // 'in' –∏–ª–∏ 'out'
    };

    // --- –ü–û–î–ì–û–¢–û–í–ö–ê ---
    const nodeStats = {};
    const nodeMap = {}; // –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –ø–æ ID

    rawNodes.forEach(n => {
        nodeStats[n.id] = { in: 0, out: 0 };
        nodeMap[n.id] = n.label;
    });

    rawEdges.forEach(e => {
        if (nodeStats[e.to]) nodeStats[e.to].in++;
        if (nodeStats[e.from]) nodeStats[e.from].out++;
    });

    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ ECharts
    const allNodes = rawNodes.map(n => {
        const s = nodeStats[n.id];
        const baseSize = n.group === 'tablet' ? 35 : 15;
        const size = Math.min(baseSize + (s.in * 2), 70);

        return {
            id: String(n.id),
            name: n.label,
            value: s.in + s.out,
            symbolSize: size,
            // --- –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –î–û–ë–ê–í–õ–ï–ù–ê ---
            draggable: true,
            // --------------------------------
            itemStyle: {
                color: n.group === 'tablet' ? '#FFBF00' : '#3B82F6',
                borderColor: '#fff',
                borderWidth: 1.5,
                shadowBlur: 10,
                shadowColor: 'rgba(0,0,0,0.5)'
            },
            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–∏–∫–∏
            url: n.url,
            statIn: s.in,
            statOut: s.out,
            isTablet: n.group === 'tablet',
            label: {
                show: true,
                color: '#eee',
                fontSize: 11,
                position: 'right'
            }
        };
    });

    const allLinks = rawEdges.map(e => ({
        source: String(e.from),
        target: String(e.to),
        lineStyle: {
            color: '#888',
            width: 2, // –°–¥–µ–ª–∞–ª —á—É—Ç—å —Ç–æ–ª—â–µ, —á—Ç–æ–±—ã –ª–µ–≥—á–µ –∫–ª–∏–∫–∞—Ç—å
            curveness: 0.1,
            opacity: 0.4
        }
    }));

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    const myChart = echarts.init(document.getElementById('chart-container'));
    let currentLayout = 'force';

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function getOption(nodes, links) {
        return {
            backgroundColor: '#2C2C2E',

            tooltip: {
                trigger: 'item',
                triggerOn: 'click',
                enterable: true,
                confine: true,
                padding: 0,
                backgroundColor: 'transparent',
                borderWidth: 0,
                formatter: function (params) {
                    // === –ü–û–î–°–ö–ê–ó–ö–ê –î–õ–Ø –£–ó–õ–ê ===
                    if (params.dataType === 'node') {
                        const d = params.data;
                        const typeLabel = d.isTablet ? "üíä –¢–∞–±–ª–µ—Ç–∫–∞" : "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞";
                        const urlText = d.url || '#';

                        return `
                            <div style="
                                background: rgba(40, 40, 45, 0.98);
                                border: 1px solid #666;
                                border-radius: 8px;
                                padding: 12px;
                                max-width: 320px;
                                box-shadow: 0 10px 30px rgba(0,0,0,0.7);
                                font-family: 'Segoe UI', sans-serif;
                            ">
                                <div style="color: #fff; font-weight: bold; font-size: 14px; margin-bottom: 6px; border-bottom: 1px solid #555; padding-bottom: 6px;">
                                    ${d.name}
                                </div>
                                <div style="font-size: 11px; color: #aaa; margin-bottom: 10px;">${typeLabel}</div>

                                <div style="font-size: 12px; color: #89b4fa; word-break: break-all; margin-bottom: 12px; background: rgba(0,0,0,0.3); padding: 6px; border-radius: 4px;">
                                    <a href="${urlText}" target="_blank" style="color: #89b4fa; text-decoration: none; border-bottom: 1px dashed #89b4fa;">
                                        ${urlText} üîó
                                    </a>
                                </div>

                                <div style="display: flex; gap: 10px;">
                                    <div class="tooltip-btn" onclick="highlightLinks('${d.id}', 'in')" style="flex:1; background: rgba(74, 222, 128, 0.15); color: #4ade80; text-align:center;">
                                        <div style="font-size:10px; opacity:0.8">–í–•–û–î–Ø–©–ò–ï</div>
                                        <div style="font-size:14px; font-weight:bold">‚Üò ${d.statIn}</div>
                                    </div>
                                    <div class="tooltip-btn" onclick="highlightLinks('${d.id}', 'out')" style="flex:1; background: rgba(244, 114, 182, 0.15); color: #f472b6; text-align:center;">
                                        <div style="font-size:10px; opacity:0.8">–ò–°–•–û–î–Ø–©–ò–ï</div>
                                        <div style="font-size:14px; font-weight:bold">‚Üó ${d.statOut}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // === –ü–û–î–°–ö–ê–ó–ö–ê –î–õ–Ø –°–í–Ø–ó–ò (–ü–û –ö–õ–ò–ö–£) ===
                    if (params.dataType === 'edge') {
                        const srcName = params.data.sourceName || nodeMap[params.data.source] || params.data.source;
                        const tgtName = params.data.targetName || nodeMap[params.data.target] || params.data.target;

                        return `
                            <div style="background: rgba(30,30,30,0.95); padding: 10px; border-radius: 6px; border: 1px solid #777; color: #fff;">
                                <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">–°–í–Ø–ó–¨</div>
                                <div style="color: #89b4fa; font-weight: bold;">${srcName}</div>
                                <div style="text-align: center; color: #aaa; margin: 2px 0;">‚¨á —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ ‚¨á</div>
                                <div style="color: #FFBF00; font-weight: bold;">${tgtName}</div>
                            </div>
                        `;
                    }
                    return null;
                }
            },

            series: [
                {
                    type: 'graph',
                    layout: currentLayout,
                    data: nodes,
                    links: links,
                    roam: true,
                    zoom: 0.6, // –ß—É—Ç—å –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤—Å—é "–∫—É—á—É"

                    label: { show: true },

                    // –°—Ç—Ä–µ–ª–∫–∏
                    edgeSymbol: ['none', 'arrow'],
                    edgeSymbolSize: [0, 8],

                    // –§–ò–ó–ò–ö–ê (–°–¥–µ–ª–∞–ª —Å–∏–ª—å–Ω–æ–µ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ)
                    force: {
                        repulsion: 200,      // –û—á–µ–Ω—å —Å–∏–ª—å–Ω–æ–µ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ (—Ä–∞—Å—Ç–∞—Å–∫–∏–≤–∞–µ—Ç –∫—É—á—É)
                        gravity: 0.01,        // –°–ª–∞–±–∞—è –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è (–Ω–µ —Å—Ç—è–≥–∏–≤–∞–µ—Ç –≤ —Ç–æ—á–∫—É)
                        edgeLength: [300, 800], // –î–ª–∏–Ω–Ω—ã–µ —Å–≤—è–∑–∏
                        layoutAnimation: true,
                        friction: 0.6         // –ß—Ç–æ–±—ã –Ω–µ "–¥—Ä–æ–∂–∞–ª–æ" –≤–µ—á–Ω–æ
                    },

                    // –ö—Ä—É–≥
                    circular: { rotateLabel: true },

                    // –ë–∞–∑–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (–µ—Å–ª–∏ –º—ã –Ω–µ –≤ —Å–ø–µ—Ü. —Ä–µ–∂–∏–º–µ)
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: { width: 4 }
                    }
                }
            ]
        };
    }

    // 5. –õ–û–ì–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø
    function updateData() {
        const showTablets = document.getElementById('showTablets').checked;

        // –§–∏–ª—å—Ç—Ä—É–µ–º
        const filteredNodes = allNodes.filter(n => (!showTablets && n.isTablet) ? false : true);
        const activeIds = new Set(filteredNodes.map(n => n.id));
        const filteredLinks = allLinks.filter(l => activeIds.has(l.source) && activeIds.has(l.target));

        document.getElementById('stat-nodes').innerText = filteredNodes.length;
        document.getElementById('stat-edges').innerText = filteredLinks.length;

        // –°–±—Ä–æ—Å –∑—É–º–∞/–ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∂–µ–ª–∞—Ç–µ–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º notMerge: false
        // –ù–æ –µ—Å–ª–∏ –º–µ–Ω—è–µ–º –Ω–∞–±–æ—Ä —É–∑–ª–æ–≤, –ª—É—á—à–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
        myChart.setOption(getOption(filteredNodes, filteredLinks), { notMerge: false });
    }

    // 6. –§–£–ù–ö–¶–ò–Ø –°–ü–ï–¶-–ü–û–î–°–í–ï–¢–ö–ò (IN/OUT)
    window.highlightLinks = function(centerId, direction) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (highlightState.active && highlightState.nodeId === centerId && highlightState.direction === direction) {
            // –ö–ª–∏–∫–Ω—É–ª–∏ –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ - —Å–±—Ä–æ—Å
            resetHighlight();
            return;
        }

        highlightState = { active: true, nodeId: centerId, direction: direction };

        const showTablets = document.getElementById('showTablets').checked;

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —É–∑–ª—ã –∏ —Å–≤—è–∑–∏ –∏–∑ –º–æ–¥–µ–ª–∏
        // –ú—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏—Å—å –ø–æ –≤—Å–µ–º –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å opacity
        const newNodes = allNodes.filter(n => (!showTablets && n.isTablet) ? false : true).map(n => {
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ä—Ç–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞–≤—Å–µ–≥–¥–∞
            const node = JSON.parse(JSON.stringify(n));

            // –¶–µ–Ω—Ç—Ä –≤—Å–µ–≥–¥–∞ —è—Ä–∫–∏–π
            if (n.id === centerId) {
                node.itemStyle.opacity = 1;
                return node;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑—å
            let isConnected = false;

            if (direction === 'in') {
                // –ò—â–µ–º, —Å—Å—ã–ª–∞–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç n –Ω–∞ centerId
                isConnected = allLinks.some(l => l.source === n.id && l.target === centerId);
            } else {
                // –ò—â–µ–º, —Å—Å—ã–ª–∞–µ—Ç—Å—è –ª–∏ centerId –Ω–∞ —ç—Ç–æ—Ç n
                isConnected = allLinks.some(l => l.source === centerId && l.target === n.id);
            }

            // –ï—Å–ª–∏ —Å–≤—è–∑–∞–Ω - —è—Ä–∫–æ, –µ—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–∑—Ä–∞—á–Ω–æ
            node.itemStyle.opacity = isConnected ? 1 : 0.1;
            node.label.show = isConnected; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º–µ–Ω–∞ —Ç–æ–ª—å–∫–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö

            return node;
        });

        const newLinks = allLinks.map(l => {
            const link = JSON.parse(JSON.stringify(l));
            let isRelevant = false;

            if (direction === 'in') {
                isRelevant = (l.target === centerId); // –í—Ö–æ–¥—è—â–∞—è –≤ —Ü–µ–Ω—Ç—Ä
            } else {
                isRelevant = (l.source === centerId); // –ò—Å—Ö–æ–¥—è—â–∞—è –∏–∑ —Ü–µ–Ω—Ç—Ä–∞
            }

            if (isRelevant) {
                link.lineStyle.opacity = 1;
                link.lineStyle.width = 2;
                link.lineStyle.color = direction === 'in' ? '#4ade80' : '#f472b6'; // –ó–µ–ª–µ–Ω—ã–π –∏–ª–∏ –†–æ–∑–æ–≤—ã–π
                link.z = 10; // –ü–æ–≤–µ—Ä—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
            } else {
                link.lineStyle.opacity = 0.05; // –ü–æ—á—Ç–∏ –Ω–µ–≤–∏–¥–∏–º—ã
            }
            return link;
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ —Å –Ω–æ–≤—ã–º–∏ —Å—Ç–∏–ª—è–º–∏
        myChart.setOption({
            series: [{
                data: newNodes,
                links: newLinks,
                // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π emphasis, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –Ω–∞—à–µ–º—É —Ä–µ–∂–∏–º—É
                emphasis: { disabled: true }
            }]
        });
    };

    // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (–∫–ª–∏–∫ –≤ –ø—É—Å—Ç–æ—Ç—É)
    function resetHighlight() {
        if (!highlightState.active) return;
        highlightState = { active: false, nodeId: null, direction: null };
        updateData(); // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    }

    // –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É
    myChart.getZr().on('click', function (event) {
        if (!event.target) {
            resetHighlight();
            // –¢–∞–∫–∂–µ —Å–∫—Ä—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø
            myChart.dispatchAction({ type: 'hideTip' });
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
    window.setForceLayout = function() {
        currentLayout = 'force';
        document.getElementById('btn-force').classList.add('active');
        document.getElementById('btn-circular').classList.remove('active');
        updateData();
    };

    window.setCircularLayout = function() {
        currentLayout = 'circular';
        document.getElementById('btn-circular').classList.add('active');
        document.getElementById('btn-force').classList.remove('active');
        updateData();
    };

    window.addEventListener('resize', () => myChart.resize());

    // –°—Ç–∞—Ä—Ç
    updateData();

</script>
</body>
</html>